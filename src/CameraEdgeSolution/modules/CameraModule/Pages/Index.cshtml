@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}


<div class="text-center">
    <div id="app">
        <div class="row">
            <div class="col-xs-6">
                <button class="btn btn-lg btn-primary" :disabled="isWorking" v-on:click="newPhoto">Take Photo</button>
            </div>
            <div class="col-xs-6">
                {{ message }}
            </div>
        </div>
        <div class="row selected-image">
            <div class="col-xs-12">
                <img class="selected-image" v-bind:src="selectedImageURL" /> 
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
                <ul class="list-inline" id="album">
                    <li class="list-inline-item" v-for="item in photos" v-on:click="selectPhoto(item)">
                        <img class="img-thumbnail" v-bind:src="item.thumbnailURL" />
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>


@section Scripts {
<script type="text/javascript">
var app = new Vue({
        el: '#app',
        data: {
            message: '',
            photos: [],
            selectedImageURL: '',
            apiURL: '',
            isWorking: false
        }, methods: {
            getThumbnailURL: function(image) {
                return this.apiURL + '/api/camera/photos/' + encodeURI(image) + "?width=80&height=62"
            },
            newPhoto: function() {
                this.message = 'Taking new photo...';
                this.isWorking = true;
                axios
                    .post(this.apiURL + '/api/camera/photos')
                    .then(response => {
                        this.message = '';
                        this.isWorking = false;
                    });                
            },
            selectPhoto: function(photoItem) {
                this.selectedImageURL = photoItem.imageURL;
            }
        },
        mounted() {
            // gets the current photos
            this.apiURL = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port;
            axios
                .get(this.apiURL + '/api/camera/photos')
                .then(response => {
                    for (var i=0; i < response.data.length; ++i){
                        var imageName = response.data[i];
                        var imageURL = this.apiURL + '/api/camera/photos/' + encodeURI(imageName);
                        var newItem = { imageURL: imageURL, thumbnailURL: this.getThumbnailURL(imageName) };
                        this.photos.push(newItem);
                    }
                });   

            // connects to signalr
            var connection = new signalR.HubConnectionBuilder()
                .withUrl("/cameraHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();
            
            connection.start().catch((function(err){
                return console.error(err.toString());
            }));

            connection.on("onnewphoto", (message) => {
                if (message.filename) {
                    var newImageURL = this.apiURL + '/api/camera/photos/' + encodeURI(message.filename);
                    var newItem = { imageURL: newImageURL, thumbnailURL: this.getThumbnailURL(message.filename) };
                        
                    this.photos.unshift(newItem);
                    this.selectedImageURL = newImageURL;
                } 
            });
        }
    });
</script>

}